{%- liquid
  assign style = section.settings.header_style | default: 'classic'
  assign has_announcement = false
  if section.settings.show_announcement and section.settings.announcement_text != blank
    assign has_announcement = true
  endif
-%}

{%- comment -%} Dynamic CSS variables based on section settings {%- endcomment -%}
<style>
  :root {
    {% case style %}
      {% when 'minimal' %}--header-height: 3.5rem;
      {% when 'editorial' %}--header-height: 5.5rem;
      {% else %}--header-height: 4.5rem;
    {% endcase %}
    --announcement-height: {% if has_announcement %}2.25rem{% else %}0px{% endif %};
  }
</style>

{{ 'header.css' | asset_url | stylesheet_tag }}

{%- comment -%} ── Announcement Bar ── {%- endcomment -%}
{% if has_announcement %}
  <div class="announcement" data-announcement>
    <p class="announcement__text">{{ section.settings.announcement_text }}</p>
  </div>
{% endif %}

{%- comment -%} ── Header ── {%- endcomment -%}
<header class="hdr" data-header data-sticky="{{ section.settings.sticky_header }}" data-style="{{ style }}">
  <div class="hdr__inner">

    {%- comment -%} Left: hamburger (mobile) + nav (desktop) {%- endcomment -%}
    <div class="hdr__zone hdr__zone--left">
      <button class="hdr__toggle" data-mobile-menu-toggle aria-label="Menu" aria-expanded="false" aria-controls="mobile-menu">
        <svg width="22" height="22" viewBox="0 0 22 22" fill="none" stroke="currentColor" stroke-width="1.5">
          <line class="hdr__toggle-line hdr__toggle-line--1" x1="3" y1="6" x2="19" y2="6"/>
          <line class="hdr__toggle-line hdr__toggle-line--2" x1="3" y1="11" x2="19" y2="11"/>
          <line class="hdr__toggle-line hdr__toggle-line--3" x1="3" y1="16" x2="15" y2="16"/>
        </svg>
      </button>

      <nav class="hdr__nav" aria-label="Main navigation">
        {% for link in section.settings.menu.links %}
          {% if link.links.size > 0 %}
            <div class="hdr__nav-item hdr__nav-item--has-dropdown">
              <a href="{{ link.url }}" class="hdr__nav-link" aria-haspopup="true" aria-expanded="false">
                {{ link.title }}
                <svg class="hdr__nav-chevron" width="10" height="10" viewBox="0 0 10 10" fill="none" stroke="currentColor" stroke-width="1.5">
                  <polyline points="2 4 5 7 8 4"/>
                </svg>
              </a>
              <div class="mega" data-mega-menu>
                <div class="mega__inner">
                  <div class="mega__grid">
                    {% for child in link.links %}
                      <div class="mega__group">
                        <a href="{{ child.url }}" class="mega__heading">{{ child.title }}</a>
                        {% if child.links.size > 0 %}
                          <ul class="mega__list">
                            {% for grandchild in child.links %}
                              <li><a href="{{ grandchild.url }}" class="mega__link">{{ grandchild.title }}</a></li>
                            {% endfor %}
                          </ul>
                        {% endif %}
                      </div>
                    {% endfor %}
                  </div>
                </div>
              </div>
            </div>
          {% else %}
            <a href="{{ link.url }}" class="hdr__nav-link">{{ link.title }}</a>
          {% endif %}
        {% endfor %}
      </nav>
    </div>

    {%- comment -%} Center: Logo {%- endcomment -%}
    <div class="hdr__zone hdr__zone--center">
      <a href="{{ routes.root_url }}" class="hdr__logo">
        {% if section.settings.logo != blank %}
          {{ section.settings.logo | image_url: width: 200 | image_tag: class: 'hdr__logo-img', loading: 'eager' }}
        {% endif %}
        {% if section.settings.show_title %}
          <span class="hdr__logo-text">{{ shop.name }}</span>
        {% endif %}
      </a>
    </div>

    {%- comment -%} Right: Search, Account, Cart {%- endcomment -%}
    <div class="hdr__zone hdr__zone--right">
      <button class="hdr__icon" data-search-trigger aria-label="{{ 'general.search' | t }}">
        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.5">
          <circle cx="8.5" cy="8.5" r="5.5"/>
          <line x1="13" y1="13" x2="18" y2="18"/>
        </svg>
      </button>

      {% if shop.customer_accounts_enabled %}
        <a href="{{ routes.account_url }}" class="hdr__icon" aria-label="{{ 'general.account' | t }}">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.5">
            <circle cx="10" cy="6.5" r="3"/>
            <path d="M2.5 19c0-4 3.5-7 7.5-7s7.5 3 7.5 7"/>
          </svg>
        </a>
      {% endif %}

      <a href="{{ routes.cart_url }}" class="hdr__icon" data-cart-trigger aria-label="{{ 'general.cart' | t }}">
        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.5">
          <path d="M4 6h12l-1 11H5L4 6z"/>
          <path d="M7 6V4a3 3 0 0 1 6 0v2"/>
        </svg>
        <span class="hdr__cart-count" data-cart-count {% if cart.item_count == 0 %}hidden{% endif %}>
          {{ cart.item_count }}
        </span>
      </a>
    </div>

  </div>
</header>

{%- comment -%} ── Mobile Menu (Full-screen takeover) ── {%- endcomment -%}
<nav class="mob" id="mobile-menu" data-mobile-menu aria-label="Mobile navigation">
  <div class="mob__header">
    <a href="{{ routes.root_url }}" class="mob__logo">
      {% if section.settings.show_title %}{{ shop.name }}{% endif %}
    </a>
    <button class="mob__close" data-mobile-menu-close aria-label="Close menu">
      <svg width="22" height="22" viewBox="0 0 22 22" fill="none" stroke="currentColor" stroke-width="1.5">
        <line x1="5" y1="5" x2="17" y2="17"/>
        <line x1="17" y1="5" x2="5" y2="17"/>
      </svg>
    </button>
  </div>

  <div class="mob__body">
    {% for link in section.settings.menu.links %}
      <a href="{{ link.url }}" class="mob__link" style="--i:{{ forloop.index0 }}">{{ link.title }}</a>
      {% if link.links.size > 0 %}
        <div class="mob__sub">
          {% for child in link.links %}
            <a href="{{ child.url }}" class="mob__sub-link" style="--i:{{ forloop.index0 }}">{{ child.title }}</a>
          {% endfor %}
        </div>
      {% endif %}
    {% endfor %}
  </div>

  <div class="mob__footer">
    {% if shop.customer_accounts_enabled %}
      <a href="{{ routes.account_url }}" class="mob__footer-link">
        <svg width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.5">
          <circle cx="10" cy="6.5" r="3"/>
          <path d="M2.5 19c0-4 3.5-7 7.5-7s7.5 3 7.5 7"/>
        </svg>
        {{ 'general.account' | t | default: 'Account' }}
      </a>
    {% endif %}
  </div>
</nav>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const header = document.querySelector('[data-header]');
    const announcement = document.querySelector('[data-announcement]');
    const toggle = document.querySelector('[data-mobile-menu-toggle]');
    const menu = document.querySelector('[data-mobile-menu]');
    const closeBtn = document.querySelector('[data-mobile-menu-close]');

    /* ── Scroll: sticky header + announcement hide ── */
    if (header?.dataset.sticky === 'true') {
      window.addEventListener('scroll', () => {
        const scrolled = window.scrollY > 60;
        header.classList.toggle('is-scrolled', scrolled);
        if (announcement) announcement.classList.toggle('is-hidden', scrolled);
      }, { passive: true });
    }

    /* ── Mobile menu ── */
    function openMenu() {
      menu?.classList.add('is-open');
      toggle?.classList.add('is-active');
      toggle?.setAttribute('aria-expanded', 'true');
      document.body.style.overflow = 'hidden';
    }

    function closeMenu() {
      menu?.classList.remove('is-open');
      toggle?.classList.remove('is-active');
      toggle?.setAttribute('aria-expanded', 'false');
      document.body.style.overflow = '';
    }

    toggle?.addEventListener('click', () => {
      menu?.classList.contains('is-open') ? closeMenu() : openMenu();
    });

    closeBtn?.addEventListener('click', closeMenu);

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeMenu();
    });

    window.addEventListener('resize', () => {
      if (window.innerWidth >= 768) closeMenu();
    });
  });
</script>

{% schema %}
{
  "name": "t:general.header",
  "settings": [
    {
      "type": "link_list",
      "id": "menu",
      "label": "t:labels.menu",
      "default": "main-menu"
    },
    {
      "type": "image_picker",
      "id": "logo",
      "label": "Logo image"
    },
    {
      "type": "checkbox",
      "id": "show_title",
      "label": "Show shop name",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_announcement",
      "label": "Show announcement bar",
      "default": false
    },
    {
      "type": "text",
      "id": "announcement_text",
      "label": "Announcement text",
      "default": "Free shipping on orders over $100"
    },
    {
      "type": "checkbox",
      "id": "sticky_header",
      "label": "Sticky header",
      "default": true
    },
    {
      "type": "select",
      "id": "header_style",
      "label": "Header style",
      "default": "classic",
      "options": [
        { "value": "minimal", "label": "Minimal" },
        { "value": "classic", "label": "Classic" },
        { "value": "editorial", "label": "Editorial" }
      ]
    }
  ]
}
{% endschema %}
